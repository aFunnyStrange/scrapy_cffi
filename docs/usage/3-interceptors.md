# 1.Introduction
In modern network communication, various middleware are often referred to as **Interceptors**. To align with this modern terminology, `scrapy_cffi` adopts the term **Interceptor** to define its middleware, which functionally correspond to the middlewares in `scrapy`.

# 2.BaseInterceptor
A common base class for `DownloadInterceptor` and `SpiderInterceptor`, serving as the unified interceptor interface within the framework.

| Attribute | Description |
| --------- | ----------- |
| settings | Global configuration from `settings.py` for convenient access |

```python 
RequestType = Union[HttpRequest, WebSocketRequest]
ResponseType = Union[HttpResponse, WebSocketResponse]
```

## 2.1 DownloadInterceptor
#### 2.1.1 Methods
#### 2.1.1.1 request_intercept(self, request: RequestType, spider: Spider)
Request interceptor, equivalent to `scrapy`’s `process_request`.
**Parameters**: 
    **request**: **RequestType** - the request object
    **spider**: **Spider** -  the spider that initiated the request
**Returns**: `Union[Request, Response, BaseException, None]`
    - `None`, No modification, pass to the next interceptor until reaching the downloader
    - `Request`, Interrupt the chain immediately, returning the request to the scheduler for re-scheduling
        -**Note:**
            1.If the request fingerprint is unchanged, the framework will automatically deduplicate. Modified requests are still subject to deduplication; to bypass this, set `dont_filter=True`.
            2.Returning a request must meet certain user-defined conditions; otherwise, it risks causing infinite loops.
    - `Response`, Interrupt the chain, send the response directly to the spider
    - `BaseException`, Interrupt the chain, handle the exception via `exception_intercept`

#### 2.1.1.2 response_intercept(self, request: RequestType, response: ResponseType, spider: Spider)
Response interceptor, equivalent to `scrapy`’s `process_response`.
**Parameters**: 
    **request**: **RequestType** - the original request object
    **response**: **ResponseType** - the response object
    **spider**: **Spider** - the spider that initiated the request
**Returns**: `Union[Request, Response, BaseException, None]`
    - `Request`, Interrupt the chain, return request to scheduler for re-scheduling
        -**Note:** Same as in request_intercept about fingerprint and filtering.
    - `Union[None, Response]`, Pass the response to the spider
        - `None` means no modification and continue to next interceptor until all are processed
        - `Response` interrupts the chain and returns response directly to spider
    - `BaseException`, Interrupt the chain, handle exception via `exception_intercept`

#### 2.1.1.3 exception_intercept(self, request: RequestType, exception: BaseException, spider: Spider)
Exception interceptor, equivalent to `scrapy`’s `process_exception`.
**Parameters**: 
    **request**: **RequestType** - the original request object
    **exception**: **BaseException** - the exception object
    **spider**: **Spider** - the spider that initiated the request
**Returns**: `Union[Request, Response, BaseException, None]`
    - `Request`, Interrupt the chain, return request to scheduler for re-scheduling
        -**Note:** Same conditions apply for deduplication and filtering as above.
    - `Response`, Return response to spider
    - `Union[None, BaseException]`
        - `None` means no modification and continue passing to next interceptor.
        - `BaseException` interrupts the chain and returns to the engine; if the spider defines an errback, it will be called, otherwise the exception is discarded
    

## 2.2 SpiderInterceptor
```python
ResultType = Union[Request, Item, Dict, None]
```

#### 2.2.1 Methods
#### 2.2.1.1 process_spider_input(self, response: ResponseType, spider: Spider)
Process the response or exception before it enters the spider.
**Parameters**: 
    **response**: **ResponseType** - response object or exception if spider has errback
    **spider**: **Spider** - the spider instance
**Returns**: `Union[BaseException, None]`
    - `None`, Continue to the next interceptor until all are processed and the response is passed to spider
    - `BaseException`, Interrupt the chain; if spider has errback, it will be invoked, otherwise exception discarded

#### 2.2.1.2 process_spider_output(self, response: ResponseType, result: ResultType, spider: Spider)
Process the output generated by the spider.
**Parameters**: 
    **response**: **ResponseType** - the response object passed to spider callback
    **result**: **ResultType**  corresponds to `Spider Output` defined in `1-spiders.md`; internally split into `Union[Request, Item, Dict, None]`
    **spider**: **Spider** - the spider instance
**Returns**: `Union[Request, Item, Dict, BaseException, None]`
    - May return any type of `Spider Output` defined above; internally broken down to single `Request`, `Item`, `Dict` or `None`
    - `None`, No operation, continue to next interceptor until no handlers remain and result is discarded
    - `BaseException`, Interrupt the chain; exception handled by `process_spider_exception`

#### 2.2.1.3 process_spider_exception(self, response: ResponseType, exception: BaseException, spider: Spider)
Handle exceptions raised in the spider.
**Parameters**: 
    **response**: **ResponseType** - the response object passed to spider callback
    **exception**: **BaseException** - the exception object
    **spider**: **Spider** - the spider instance
**Returns**: `Union[Request, Item, dict, BaseException, None]`
    - `Request`, Interrupt the chain, send request to scheduler for re-scheduling
    - `None`, No operation, continue to next interceptor until none remain, then discard
    - `BaseException`, Interrupt the chain, discard the exception
    - `Union[Item, dict]`, Send output to the pipeline
